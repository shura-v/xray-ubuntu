#!/bin/bash

set -e

WG_DIR="/etc/wireguard"
WG_CONF="$WG_DIR/wg0.conf"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ WireGuard
if [ ! -f "$WG_CONF" ]; then
  echo "‚ùå –§–∞–π–ª –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ WireGuard –Ω–µ –Ω–∞–π–¥–µ–Ω: $WG_CONF"
  exit 1
fi

# –ü–µ—Ä–µ—á–∏—Å–ª–µ–Ω–∏–µ –≤—Å–µ—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤ –∏–∑ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
echo "üìã –°–ø–∏—Å–æ–∫ –∫–ª–∏–µ–Ω—Ç–æ–≤ WireGuard:"
echo "----------------------------"

CLIENTS=()

# –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –∫–ª–∏–µ–Ω—Ç–æ–≤
grep -A 3 '\[Peer\]' "$WG_CONF" | while read -r line; do
  # –ò—â–µ–º —Å—Ç—Ä–æ–∫–∏ —Å –ø—É–±–ª–∏—á–Ω—ã–º –∫–ª—é—á–æ–º –∏ IP-–∞–¥—Ä–µ—Å–æ–º
  if [[ "$line" =~ PublicKey\ =\ (.*) ]]; then
    CLIENT_PUB="${BASH_REMATCH[1]}"
  elif [[ "$line" =~ AllowedIPs\ =\ (.*) ]]; then
    CLIENT_IP="${BASH_REMATCH[1]}"

    # –ò—â–µ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –ø–µ—Ä–µ–¥ –±–ª–æ–∫–æ–º –∫–ª–∏–µ–Ω—Ç–∞
    CLIENT_COMMENT=$(grep -B 1 "PublicKey = $CLIENT_PUB" "$WG_CONF" | grep '^#' | tail -n 1)

    CLIENT_NAME="${CLIENT_COMMENT//\#/}"  # –£–±–∏—Ä–∞–µ–º –∑–Ω–∞–∫ '#' –∏–∑ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è
    CLIENT_NAME="${CLIENT_NAME// /}"     # –£–±–∏—Ä–∞–µ–º –ª–∏—à–Ω–∏–µ –ø—Ä–æ–±–µ–ª—ã

    CLIENTS+=("$CLIENT_NAME")

    # –ü–µ—á–∞—Ç–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–ª–∏–µ–Ω—Ç–µ
    echo "–ò–º—è –∫–ª–∏–µ–Ω—Ç–∞: $CLIENT_NAME"
    echo "–ü—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á –∫–ª–∏–µ–Ω—Ç–∞: $CLIENT_PUB"
    echo "----------------------------"
  fi
done

echo "‚úÖ –°–ø–∏—Å–æ–∫ –∫–ª–∏–µ–Ω—Ç–æ–≤ –∑–∞–≤–µ—Ä—à—ë–Ω!"

# –ï—Å–ª–∏ –ø–µ—Ä–µ–¥–∞–Ω –∞—Ä–≥—É–º–µ–Ω—Ç, –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ –∫–∞–∫ –∏–º—è –∫–ª–∏–µ–Ω—Ç–∞ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è
if [ "$#" -eq 1 ]; then
  CLIENT_NAME=$1
else
  # –ï—Å–ª–∏ –∞—Ä–≥—É–º–µ–Ω—Ç –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω, –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤—ã–±–æ—Ä
  read -p "–í–≤–µ–¥–∏—Ç–µ –∏–º—è –∫–ª–∏–µ–Ω—Ç–∞ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è: " CLIENT_NAME
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞
if [[ ! " ${CLIENTS[@]} " =~ " $CLIENT_NAME " ]]; then
  echo "‚ùå –ö–ª–∏–µ–Ω—Ç '$CLIENT_NAME' –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –∫–æ–Ω—Ñ–∏–≥–µ!"
  exit 1
fi

# –ù–∞—Ö–æ–¥–∏–º –ø—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á –∫–ª–∏–µ–Ω—Ç–∞ –∏–∑ –µ–≥–æ –∏–º–µ–Ω–∏
CLIENT_PUB=$(grep -A 3 "$CLIENT_NAME" "$WG_CONF" | grep -m 1 "PublicKey" | cut -d' ' -f3)

echo "üîß –£–¥–∞–ª—è–µ–º –∫–ª–∏–µ–Ω—Ç–∞ '$CLIENT_NAME' —Å –ø—É–±–ª–∏—á–Ω—ã–º –∫–ª—é—á–æ–º '$CLIENT_PUB' –∏–∑ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ —Å–µ—Ä–≤–µ—Ä–∞..."

# –ù–∞—Ö–æ–¥–∏–º —Å—Ç—Ä–æ–∫—É —Å –Ω–æ–º–µ—Ä–æ–º –¥–ª—è –ø—É–±–ª–∏—á–Ω–æ–≥–æ –∫–ª—é—á–∞
CLIENT_LINE=$(grep -n "PublicKey = $CLIENT_PUB" "$WG_CONF" | cut -d: -f1)

# –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ –ø—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á –Ω–∞–π–¥–µ–Ω
if [ -z "$CLIENT_LINE" ]; then
  echo "‚ùå –ö–ª–∏–µ–Ω—Ç —Å –ø—É–±–ª–∏—á–Ω—ã–º –∫–ª—é—á–æ–º '$CLIENT_PUB' –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ WireGuard!"
  exit 1
fi

# –ù–∞—Ö–æ–¥–∏–º —Å—Ç—Ä–æ–∫—É –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è (–±–ª–æ–∫ –∫–ª–∏–µ–Ω—Ç–∞) –Ω–∞—á–∏–Ω–∞—è —Å –Ω–∞–π–¥–µ–Ω–Ω–æ–π —Å—Ç—Ä–æ–∫–∏ –¥–æ —Å–ª–µ–¥—É—é—â–µ–≥–æ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è –∏–ª–∏ –∫–æ–Ω—Ü–∞
echo "–£–¥–∞–ª–µ–Ω–∏–µ –±–ª–æ–∫–∞ –∫–ª–∏–µ–Ω—Ç–∞ —Å –ø—É–±–ª–∏—á–Ω—ã–º –∫–ª—é—á–æ–º '$CLIENT_PUB'..."
sudo sed -i "${CLIENT_LINE},/^$/d" "$WG_CONF"

# –£–¥–∞–ª—è–µ–º –∫–ª—é—á–∏ –∫–ª–∏–µ–Ω—Ç–∞
sudo rm -f "$WG_DIR/$CLIENT_NAME-privatekey"
sudo rm -f "$WG_DIR/$CLIENT_NAME-publickey"

# –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ WireGuard
echo "üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º WireGuard..."
sudo systemctl restart wg-quick@wg0

echo "‚úÖ –ö–ª–∏–µ–Ω—Ç '$CLIENT_NAME' —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª—ë–Ω –∏–∑ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏!"
