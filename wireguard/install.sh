#!/bin/bash

set -e

# –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ WireGuard –µ—â—ë –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
if ! command -v wg &> /dev/null; then
  echo "üîß –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º WireGuard..."
  sudo apt update
  sudo apt install -y wireguard wireguard-tools
else
  echo "üîß WireGuard —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!"
fi

# –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–ª—é—á–µ–π –¥–ª—è —Å–µ—Ä–≤–µ—Ä–∞
echo "üîê –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–ª—é—á–µ–π –¥–ª—è —Å–µ—Ä–≤–µ—Ä–∞..."
sudo mkdir -p /etc/wireguard
wg genkey | tee /etc/wireguard/privatekey | wg pubkey > /etc/wireguard/publickey

PRIVATE_KEY=$(cat /etc/wireguard/privatekey)
PUBLIC_KEY=$(cat /etc/wireguard/publickey)

# –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –¥–ª—è —Å–µ—Ä–≤–µ—Ä–∞
echo "üîß –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –¥–ª—è —Å–µ—Ä–≤–µ—Ä–∞..."
cat <<EOF | sudo tee /etc/wireguard/wg0.conf > /dev/null
[Interface]
PrivateKey = $PRIVATE_KEY
Address = 10.0.0.1/24
ListenPort = 51820
SaveConfig = true

# –î–æ–±–∞–≤–ª—è–µ–º peer –ø–æ–∑–∂–µ —á–µ—Ä–µ–∑ add.sh
EOF

# –í–∫–ª—é—á–µ–Ω–∏–µ IP —Ñ–æ—Ä–≤–∞—Ä–¥–∏–Ω–≥–∞
echo "üîß –í–∫–ª—é—á–∞–µ–º IP —Ñ–æ—Ä–≤–∞—Ä–¥–∏–Ω–≥..."
sudo sysctl -w net.ipv4.ip_forward=1
sudo sysctl -w net.ipv6.conf.all.disable_ipv6=1

# –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫
echo "net.ipv4.ip_forward=1" | sudo tee -a /etc/sysctl.conf
echo "net.ipv6.conf.all.disable_ipv6=1" | sudo tee -a /etc/sysctl.conf

# –ó–∞–ø—É—Å–∫ WireGuard
echo "üîß –ó–∞–ø—É—Å–∫–∞–µ–º WireGuard..."
sudo systemctl enable wg-quick@wg0
sudo systemctl start wg-quick@wg0

# –ü—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á —Å–µ—Ä–≤–µ—Ä–∞
echo "‚úÖ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞!"
echo "üîë –ü—Ä–∏–≤–∞—Ç–Ω—ã–π –∫–ª—é—á —Å–µ—Ä–≤–µ—Ä–∞: $PRIVATE_KEY"
echo "üîë –ü—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á —Å–µ—Ä–≤–µ—Ä–∞: $PUBLIC_KEY"

echo "üìÑ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –¥–ª—è —Å–µ—Ä–≤–µ—Ä–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –≤ /etc/wireguard/wg0.conf"
echo "üöÄ –ù–µ –∑–∞–±—É–¥—å –¥–æ–±–∞–≤–∏—Ç—å –∫–ª–∏–µ–Ω—Ç–æ–≤ —á–µ—Ä–µ–∑ ./add.sh"

# –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ WireGuard
sudo systemctl restart wg-quick@wg0
