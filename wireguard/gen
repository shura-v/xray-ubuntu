#!/bin/bash

set -e

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤
if [ "$#" -ne 2 ]; then
  echo "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: $0 <client_name> <client_ip>"
  echo "–ü—Ä–∏–º–µ—Ä: $0 phone 10.0.0.5"
  exit 1
fi

CLIENT_NAME=$1
CLIENT_IP=$2
WG_DIR="/etc/wireguard"
CLIENT_DIR="$WG_DIR/clients/$CLIENT_NAME"
WG_CONF="$WG_DIR/wg0.conf"
SERVER_ENDPOINT="91.228.154.210:41641"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ wg0.conf
if [ ! -f "$WG_CONF" ]; then
  echo "‚ùå –§–∞–π–ª $WG_CONF –Ω–µ –Ω–∞–π–¥–µ–Ω!"
  exit 1
fi

# –ü–æ–ª—É—á–µ–Ω–∏–µ –ø—É–±–ª–∏—á–Ω–æ–≥–æ –∫–ª—é—á–∞ —Å–µ—Ä–≤–µ—Ä–∞
SERVER_PUB=$(wg pubkey < "$WG_DIR/privatekey")

# –°–æ–∑–¥–∞–Ω–∏–µ –ø–∞–ø–∫–∏ –∫–ª–∏–µ–Ω—Ç–∞
sudo mkdir -p "$CLIENT_DIR"
cd "$CLIENT_DIR"

# –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–ª—é—á–µ–π –∫–ª–∏–µ–Ω—Ç–∞
wg genkey | tee privatekey | wg pubkey > publickey

CLIENT_PRIV=$(cat privatekey)
CLIENT_PUB=$(cat publickey)

# –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞ –≤ wg0.conf
if grep -q "$CLIENT_PUB" "$WG_CONF"; then
  echo "‚ö†Ô∏è –ü–∏—Ä —Å —ç—Ç–∏–º –∫–ª—é—á–æ–º —É–∂–µ –µ—Å—Ç—å –≤ $WG_CONF"
else
  echo "" | sudo tee -a "$WG_CONF" > /dev/null
  echo "# $CLIENT_NAME" | sudo tee -a "$WG_CONF" > /dev/null
  echo "[Peer]" | sudo tee -a "$WG_CONF" > /dev/null
  echo "PublicKey = $CLIENT_PUB" | sudo tee -a "$WG_CONF" > /dev/null
  echo "AllowedIPs = $CLIENT_IP/32" | sudo tee -a "$WG_CONF" > /dev/null
  echo "‚úÖ –î–æ–±–∞–≤–ª–µ–Ω –≤ $WG_CONF"
fi

# –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –∫–ª–∏–µ–Ω—Ç–∞
cat <<EOF | sudo tee "$CLIENT_DIR/$CLIENT_NAME.conf" > /dev/null
[Interface]
PrivateKey = $CLIENT_PRIV
Address = $CLIENT_IP/32
DNS = 1.1.1.1

[Peer]
PublicKey = $SERVER_PUB
Endpoint = $SERVER_ENDPOINT
AllowedIPs = 0.0.0.0/0
PersistentKeepalive = 25
EOF

echo
echo "üìÑ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∫–ª–∏–µ–Ω—Ç–∞ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–∞: $CLIENT_DIR/$CLIENT_NAME.conf"
echo "üìÅ –ö–ª—é—á–∏: $CLIENT_DIR"
echo
echo "üöÄ –ù–µ –∑–∞–±—É–¥—å:"
echo "sudo systemctl restart wg-quick@wg0"
